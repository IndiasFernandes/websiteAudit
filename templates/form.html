{% extends 'partials/base.html' %}

{% load widget_tweaks %}
{% block content %}
<div class="container mt-5">
    <div class="row">
        <div class="col-md-6 offset-md-3">
            <h2 class="mb-4 text-center">Form Test</h2>
            <form id="myForm" method="post" class="needs-validation" novalidate>
                {% csrf_token %}
                <div class="form-group">
                    {{ form.url.label_tag }}
                    {{ form.url|add_class:"form-control" }}
                </div>
                <div class="form-group">
                    {{ form.name_company.label_tag }}
                    {{ form.name_company|add_class:"form-control" }}
                </div>
                <div class="form-group">
                    {{ form.first_name.label_tag }}
                    {{ form.first_name|add_class:"form-control" }}
                </div>
                <div class="form-group">
                    {{ form.last_name.label_tag }}
                    {{ form.last_name|add_class:"form-control" }}
                </div>
                <div class="form-group">
                    {{ form.email.label_tag }}
                    {{ form.email|add_class:"form-control" }}
                </div>
                <div class="form-check mb-4">
                    {{ form.accept_terms|add_class:"form-check-input" }}
                    {{ form.accept_terms.label_tag }}
                </div>
                <div class="d-grid gap-2">
                    <button type="submit" data-action="https://app.ai-leadmagnets.com/api/report/add/" class="btn btn-primary btn-block" id="submitApi">Submit to API</button>
                    <button type="submit" data-action="http://localhost:8000/api/report/add/" class="btn btn-secondary btn-block" id="submitLocalhost">Submit to Localhost</button>
                </div>
            </form>
            <br>
            <div id="submissionStatus"></div>
        </div>
    </div>
</div>
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script>
$(document).ready(function() {
    // Function to submit form data
    function submitFormData(url, formData) {
        var postData = {};
        $.each(formData, function(_, kv) {
            postData[kv.name] = kv.value;
        });

        // Include CSRF token
        var csrftoken = $('[name=csrfmiddlewaretoken]').val();

        // Post the JSON data to the specified endpoint
        $.ajax({
            type: "POST",
            url: url,
            data: JSON.stringify(postData),
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            // Include CSRF token in the request header
            beforeSend: function(xhr) {
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
            },
            success: function(response) {
                console.log("Data successfully submitted:", response);
                var formattedResponse = "<h3>Submission Successful!</h3>";
                Object.keys(response).forEach(function(key) {
                    formattedResponse += "<p><strong>" + key.charAt(0).toUpperCase() + key.slice(1).replace(/_/g, ' ') + ": </strong>" + response[key] + "</p>";
                });
                $("#submissionStatus").html(formattedResponse);
            },
            error: function(xhr, status, error) {
                // Handle error response
                console.error("Error:", error);
                $("#submissionStatus").html("<p>Submission failed.</p><p>Error: " + error + "</p>");
            }
        });
    }

    // Handler for form submission
    $("button[type=submit]").click(function(event) {
        event.preventDefault(); // Prevent the default form submission
        var form = $("#myForm");
        var formData = form.serializeArray();
        var url = $(this).data('action'); // Get the URL from the button's data-action attribute
        console.log("Submitting form data to:", url);
        console.log("Form data:", formData);
        submitFormData(url, formData);
    });
});
</script>
{% endblock %}
```